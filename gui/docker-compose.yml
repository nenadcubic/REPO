services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command:
      - "redis-server"
      - "--appendonly"
      - "yes"
    volumes:
      - er_gui_redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep -q PONG"]
      interval: 3s
      timeout: 2s
      retries: 20

  backend:
    build:
      context: ..
      dockerfile: gui/backend/Dockerfile
    restart: unless-stopped
    environment:
      - GUI_PRESET=${GUI_PRESET:-default}
      - ER_REDIS_HOST=${ER_REDIS_HOST:-}
      - ER_REDIS_PORT=${ER_REDIS_PORT:-}
      - ER_CLI_PATH=/usr/local/bin/er_cli
      - ER_GUI_LOG_PATH=/app/logs/backend.log
      - ER_GUI_LOG_LEVEL=${ER_GUI_LOG_LEVEL:-info}
      - ER_GUI_STORE_PREVIEW_LIMIT=${ER_GUI_STORE_PREVIEW_LIMIT:-25}
    volumes:
      - ./presets:/app/presets
      - er_gui_backend_logs:/app/logs
    ports:
      - "${GUI_API_PORT:-8000}:8000"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/api/v1/health | grep -q '\"ok\"'"]
      interval: 5s
      timeout: 3s
      retries: 30

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${GUI_HTTP_PORT:-8080}:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost/ | grep -qi '<title>element-redis GUI</title>'"]
      interval: 5s
      timeout: 3s
      retries: 30

volumes:
  er_gui_redis_data:
  er_gui_backend_logs:
